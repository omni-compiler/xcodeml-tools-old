#!/bin/bash

# $TSUKUBA_Release: Omni OpenMP Compiler 3 $
# $TSUKUBA_Copyright:
#  PLEASE DESCRIBE LICENSE AGREEMENT HERE
#  $
OUTFILE="$1"
INPFILE="$2"

if [ -z "${OUTFILE}" ]; then
    echo output file not specified
    exit 1
fi

if [ -z "${INPFILE}" ]; then
    echo input file not specified
    exit 1
fi

if [ ! -z "${OM_TRANSLATORS}" ]; then
    OM_OPTIONS="${OM_OPTIONS} -I${OMNI_HOME}/include"
    for TID in ${OM_TRANSLATORS}; do
        CONF="${OM_DRIVER_CONF_DIR}/native.conf.${TID}"
        if [ -r ${CONF} ]; then
            . ${CONF}
        else
            echo cannot read ${CONF} script.
            exit 1
        fi
    done;
fi

GPU_COMPILER="@GPU_CMD@"
INPFILE_BASENAME=`basename "${INPFILE}"`
INPFILE_FILENAME=${INPFILE_BASENAME%.*}
newOpts=''
for i in ${OM_OPTIONS}; do
    case ${i} in
        -enable-gpu)
            if [ -f "${INPFILE_FILENAME}.cu" ]; then
                ${GPU_COMPILER} @GPU_CFLAGS@ -I"${OMNI_HOME}/include" -c "${INPFILE_FILENAME}.cu" -o "${INPFILE_FILENAME}.xmpgpu.o"
            fi;;
        -acc | -facc)
            if [ -f "${INPFILE_FILENAME}.cu" ]; then
                GPUCMD="${GPU_COMPILER} @GPU_CFLAGS@ -I"${OMNI_HOME}/include" -c "${INPFILE_FILENAME}.cu" -o "${INPFILE_FILENAME}.accgpu.o""
		$GPUCMD
            fi;;
        -tmp)
            cp "${INPFILE}" "__omni_tmp_${INPFILE_BASENAME}";;
        -moddir?*)
            j=@BEFC_MODINC@
            case ${j} in
                -to);;
                -module)
                    foo=`echo "${i}" |sed "s/-moddir\(.*\)/${j} \1/"`
                    newOpts="${newOpts} ${foo}";;
                *)
                    foo=`echo "${i}" |sed "s/-moddir\(.*\)/${j}\1/"`
                    newOpts="${newOpts} ${foo}";; 
            esac;;
        *)
            newOpts="${newOpts} ${i}";;
    esac
done
OM_OPTIONS="${newOpts}"

#--- unescape space characters, which are espaced in omdriver.c (ID=278)
OM_OPTION_ARR=()
for opt in ${OM_OPTIONS}; do
    opt1=$(echo $opt | sed 's/\\s/ /g
                            s/\\t/\t/g
                            s/\\n/\n/g
                            s/\\\\/\\/g')
    OM_OPTION_ARR=( "${OM_OPTION_ARR[@]}" "$opt1" )
done

GASNET_CPPFLAGS="@GASNET_CPPFLAGS@"
CMD=${COMPILER}
args=( "${OM_OPTION_ARR[@]}" ${GASNET_CPPFLAGS} -c "${INPFILE}" -o "${OUTFILE}" )
set -- "${args[@]}"

if [ "${OM_VERBOSE}" = "1" ]; then
    echo $CMD "$@"
    if [ -n "${GPUCMD}" ]; then
        echo $GPUCMD
    fi
fi

$CMD "$@"

if [ -n "${GPUCMD}" ]; then
    mv "${OUTFILE}" "${INPFILE_FILENAME}.acccpu.o"
    ld -r "${INPFILE_FILENAME}.acccpu.o" "${INPFILE_FILENAME}.accgpu.o" -o "${OUTFILE}"
    rm "${INPFILE_FILENAME}.acccpu.o" "${INPFILE_FILENAME}.accgpu.o"
fi

exit $?

