#!/bin/bash

# $TSUKUBA_Release: Omni OpenMP Compiler 3 $
# $TSUKUBA_Copyright:
#  PLEASE DESCRIBE LICENSE AGREEMENT HERE
#  $
OUTFILE="$1"
INPFILE="$2"

if [ -z "${OUTFILE}" ]; then
    echo output file not specified
    exit 1
fi

if [ -z "${INPFILE}" ]; then
    echo input file not specified
    exit 1
fi

if [ ! -z "${OM_TRANSLATORS}" ]; then
    OM_OPTIONS="${OM_OPTIONS} -I${OMNI_HOME}/include"
    for TID in ${OM_TRANSLATORS}; do
        CONF="${OM_DRIVER_CONF_DIR}/pp.conf.${TID}"
        if [ -r ${CONF} ]; then
            . ${CONF}
        else
            echo cannot read ${CONF} script.
            exit 1
        fi
    done;
fi

GASNET_CPPFLAGS="@GASNET_CPPFLAGS@"

TMP_FILE="${INPFILE}"
REPLACE_PRAGMA_CMD=""
INCLUDES=""
newOpts=""
for i in ${OM_OPTIONS}; do
    case ${i} in
        -no-replace-pragma)
            NO_REPLACE_PRAGMA="1";;
        -I*)
            INCLUDES="${INCLUDES} ${i}"
            newOpts="${newOpts} ${i}";;
        *)
            newOpts="${newOpts} ${i}";;
    esac
done
OM_OPTIONS="${newOpts}"

if [ -z "${NO_REPLACE_PRAGMA}" ]; then
    PID=$$
    TMP_FILE="__omni_tmp__pp_${PID}.c"
    REPLACE_PRAGMA_CMD="@OMNI_HOME@/bin/om_replace_pragma"
    RPC_ARGS=( "${INPFILE}" -o "${TMP_FILE}" ${INCLUDES} )
fi

#--- unescape space characters, which are espaced in omdriver.c (ID=278)
OM_OPTION_ARR=()
for opt in ${OM_OPTIONS}; do
    opt1=$(echo $opt | sed 's/\\s/ /g
                            s/\\t/\t/g
                            s/\\n/\n/g
                            s/\\\\/\\/g')
    OM_OPTION_ARR=( "${OM_OPTION_ARR[@]}" "$opt1" )
done

CMD=${PP}
CMD_ARGS=( "${OM_OPTION_ARR[@]}" ${GASNET_CPPFLAGS} "${TMP_FILE}" )

if [ "${OM_VERBOSE}" = "1" ]; then
    if [ "${REPLACE_PRAGMA_CMD}" != "" ]; then
        set -- "${RPC_ARGS[@]}"
        echo $REPLACE_PRAGMA_CMD "$@"
    fi  
    set -- "${CMD_ARGS[@]}"
    echo $CMD "$@" \> "${OUTFILE}"
fi

if [ "${REPLACE_PRAGMA_CMD}" != "" ]; then
    set -- "${RPC_ARGS[@]}"
    $REPLACE_PRAGMA_CMD "$@" || exit $?
#add filename to top of OUTFILE
    echo "# 1 \"${INPFILE}\"" > "${OUTFILE}"
    set -- "${CMD_ARGS[@]}"
    $CMD "$@" >> "${OUTFILE}" || exit $?
else
    set -- "${CMD_ARGS[@]}"
    $CMD "$@" > "${OUTFILE}" || exit $?
fi

if [ "${REPLACE_PRAGMA_CMD}" != "" ]; then
    rm "${TMP_FILE}"
fi
