#!/bin/bash

# $TSUKUBA_Release: Omni OpenMP Compiler 3 $
# $TSUKUBA_Copyright:
#  PLEASE DESCRIBE LICENSE AGREEMENT HERE
#  $
OUTFILE="$1"
shift
INPFILES=("$@")

if [ -z "${OUTFILE}" ]; then
    echo output file not specified
    exit 1
fi

if [ ! -z "${OM_TRANSLATORS}" ]; then
    for TID in ${OM_TRANSLATORS}; do
        CONF="${OM_DRIVER_CONF_DIR}/linker.conf.${TID}"
        if [ -r ${CONF} ]; then
            . ${CONF}
        else
            echo cannot read ${CONF} script.
            exit 1
        fi
    done;
fi

newOpts=''
for i in ${OM_OPTIONS}; do
    case "${i}" in
        -enable-gpu)
            if ls *.xmpgpu.o >/dev/null 2>&1; then
                INPFILES=("${INPFILES[@]}" *.xmpgpu.o)
            fi;;
        *)
            newOpts="${newOpts} ${i}";;
    esac
done
OM_OPTIONS="${newOpts}"

#--- unescape space characters, which are espaced in omdriver.c (ID=278)
OM_OPTION_ARR=()
for opt in ${OM_OPTIONS}; do
    opt1=$(echo $opt | sed 's/\\s/ /g
                            s/\\t/\t/g
                            s/\\n/\n/g
                            s/\\\\/\\/g')
    OM_OPTION_ARR=( "${OM_OPTION_ARR[@]}" "$opt1" )
done

CMD=${LINKER}
args=( "${OM_OPTION_ARR[@]}" "${INPFILES[@]}" ${LIBS} )
set -- "${args[@]}"

if [ "${OM_VERBOSE}" = "1" ]; then
    echo $CMD "$@"
fi

$CMD "$@"
v=$?
rm -f ${INIT_MODULE_OBJ}
rm -f /tmp/omni_traverse_${PID}.*
rm -f /tmp/omni_omlinker_${PID}.*
exit $v
