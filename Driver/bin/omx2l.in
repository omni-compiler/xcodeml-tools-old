#!/bin/bash

# $TSUKUBA_Release: Omni OpenMP Compiler 3 $
# $TSUKUBA_Copyright:
#  PLEASE DESCRIBE LICENSE AGREEMENT HERE
#  $
OUTFILE="$1"
INPFILE="$2"

if [ -z "${OUTFILE}" ]; then
    echo output file not specified
    exit 1
fi

if [ -z "${INPFILE}" ]; then
    echo input file not specified
    exit 1
fi

if [ "${OM_USE_OPENMP}" = "1" -o "${OM_USE_XMP}" = "1" -o "${OM_USE_XMPF}" = "1" -o "${OM_USE_ACC}" = "1" ]; then
    if [ "${OM_VERBOSE}" = "1" ]; then
        echo "skip backend"
    fi

    if [ "${OM_USE_ACC}" != "1" ]; then
	mv ${OUTFILE%.*}.in.c $OUTFILE
    fi

    if [ ! -e "$OUTFILE" ]; then
        echo "$OUTFILE" not found
        exit 1
    fi
    exit 0
fi

#--- unescape space characters, which are espaced in omdriver.c (ID=278)
OM_OPTION_ARR=()
for opt in ${OM_OPTIONS}; do
    opt1=$(echo $opt | sed 's/\\s/ /g
                            s/\\t/\t/g
                            s/\\n/\n/g
                            s/\\\\/\\/g')
    OM_OPTION_ARR=( "${OM_OPTION_ARR[@]}" "$opt1" )
done

CMD=${X2L}
args=( "${OM_OPTION_ARR[@]}" "${INPFILE}" -o "${OUTFILE}" )
set -- "${args[@]}"

if [ "${OM_VERBOSE}" = "1" ]; then
    echo $CMD "$@"
fi

$CMD "$@" || exit $?
