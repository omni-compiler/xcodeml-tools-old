#!/bin/bash

### Read configration file and library ###
OMNI_HOME=@OMNI_HOME@
. ${OMNI_HOME}/etc/ompf90.conf
. ${OMNI_HOME}/libexec/omni_common_lib.sh
. ${OMNI_HOME}/libexec/ompf90_lib.sh

### Directory for saving intermediate files ###
PID=$$
TEMP_DIR=/tmp/__omni_tmp__${PID}
DEBUG_TEMP_DIR="__omni_tmp__"

### Default options ###
ENABLE_LINKER=true
ONLY_PP=false
VERBOSE=false
ENABLE_DEBUG=false
OUTPUT_TEMPORAL=false
DRY_RUN=false
STOP_PP=false
STOP_FRONTEND=false
STOP_TRANSLATOR=false
STOP_BACKEND=false
STOP_COMPILE=false

# Additional options defined by command line (e.g. --Wl..)
# These parameters are set in ompf90_set_parameters().
OUTPUT_FILE=
MODULE_OPT=
PP_ADD_OPT=
FRONTEND_ADD_OPT=
XCODE_TRANSLATOR_ADD_OPT=
BACKEND_ADD_OPT=
NATIVE_ADD_OPT=
LINKER_ADD_OPT=

### Set options ###
# e.g.) ompf90 -I/usr/lib a.f b.F c.f90 d.F90 e.o --tmp --Wlfoo lib.a
#
#  F_F90_files="b.F d.F90"            # fortran files needed preprocess (*.F or *.F90)
#  f_f90_files="a.f c.f90"            # fortran files (*.f or *.f90)
#  all_files="a.f b.F c.f90 d.F90"    # all fortran files
#  archive_files="lib.a"              # Archive files
#  obj_files="e.o"                    # Object files
#  other_args="-I/usr/lib"            # Options for Preprocessor, Compiler, and Linker
# 
#  Note that "-omp" is extracted by ompf90_set_parameters, and set "ENABLE_OPENMP".
F_F90_files=
f_f90_files=
all_files=
archive_files=
obj_files=
other_args=
ompf90_set_parameters ${@+"$@"}
omni_f_check_file_exist

### Create temporal directory ###
if [ $ENABLE_DEBUG = true ]; then
    TEMP_DIR=$DEBUG_TEMP_DIR
    if [ -d $TEMP_DIR ]; then
	omni_exec rm -rf $TEMP_DIR
    fi
fi

omni_exec mkdir -p $TEMP_DIR
[ $ENABLE_DEBUG = true ] && echo "Create ${TEMP_DIR}/"

### Clean temporal directory before exit ###
omni_set_trap

### Preprocessor ###
[ $ONLY_PP = true -a -f "$OUTPUT_FILE" ] && omni_exec rm $OUTPUT_FILE
if [ $ENABLE_ACC = true ]; then
    OMNI_CPP_OPT="$OMNI_CPP_OPT ${OPENACC_DEF}"
else
    OMNI_CPP_OPT="$OMNI_CPP_OPT ${OPENMP_DEF}"
fi
for file in $F_F90_files; do
    FILE_NAME=`omni_f_norm_file_name $file`     # ./hoge/fuga.F -> hoge_2f_fuga_2f_a
    EXT=${file##*.}
    FILE_PP=${TEMP_DIR}/${FILE_NAME}.${EXT}

    omni_exec $OMNI_FPP_CMD $PP_ADD_OPT $OMNI_FPP_OPT $other_args $file ">" $FILE_PP
    # AIX compiler cannot output file with ".i" suffix. So, ">" is used.

    if [ $ONLY_PP = true ]; then
	if [ "$OUTPUT_FILE" = "" ]; then
	    omni_exec cat $FILE_PP
	else
	    omni_exec cat $FILE_PP ">>" $OUTPUT_FILE
	fi
    fi
done
for file in $f_f90_files; do
    FILE_NAME=`omni_f_norm_file_name $file`     # ./hoge/fuga.f90 -> hoge_2f_fuga_2f_a
    EXT=${file##*.}
    FILE_PP=${TEMP_DIR}/${FILE_NAME}.${EXT}

    omni_exec cp $file $FILE_PP
done
[ $STOP_PP = true ] && exit 0;
[ $ONLY_PP = true -a $ENABLE_DEBUG = true ] && exit 0;          # ompf90 -E --debug hoge.c (save $TMP_DIR)
[ $ONLY_PP = true ] && { omni_exec rm -rf $TEMP_DIR; exit 0; }  # ompf90 -E hoge.c

### Frontend ###
[ $ENABLE_ACC = true ] && FRONTEND_ADD_OPT="$FRONTEND_ADD_OPT -facc"
for file in $all_files; do
    FILE_NAME=`omni_f_norm_file_name $file`     # ./hoge/fuga.f90 -> hoge_2f_fuga_2f_a
    EXT=${file##*.}
    FILE_PP=${TEMP_DIR}/${FILE_NAME}.${EXT}
    FILE_IN_X=${TEMP_DIR}/${FILE_NAME}_${EXT}_in.xml

    omni_exec $OMNI_F2X_CMD $FRONTEND_ADD_OPT $OMNI_F2X_OPT $FILE_PP -o $FILE_IN_X
done
[ $STOP_FRONTEND = true ] && exit 0;

### Translator ###
if [ $ENABLE_ACC = true ]; then
    XCODE_TRANSLATOR_ADD_OPT="$XCODE_TRANSLATOR_ADD_OPT -facc"
else
    XCODE_TRANSLATOR_ADD_OPT="$XCODE_TRANSLATOR_ADD_OPT -fopenmp"
fi
for file in $all_files; do
    FILE_NAME=`omni_f_norm_file_name $file`     # ./hoge/fuga.f90 -> hoge_2f_fuga_2f_a
    EXT=${file##*.}
    FILE_IN_X=${TEMP_DIR}/${FILE_NAME}_${EXT}_in.xml
    FILE_OUT_X=${TEMP_DIR}/${FILE_NAME}_${EXT}_out.xml
    FILE_F=${TEMP_DIR}/${FILE_NAME}.${EXT}

    omni_exec $OMNI_FX2X_CMD $OMNI_FX2X_OPT $XCODE_TRANSLATOR_ADD_OPT $MODULE_OPT $FILE_IN_X -o $FILE_OUT_X
    # also create ${TEMP_DIR}/${FILE_NAME}_${EXT}_in.F90

    mv ${TEMP_DIR}/${FILE_NAME}_${EXT}_in.F90 $FILE_F
done
[ $STOP_TRANSLATOR = true ] && exit 0;

### Backend ###
if [ $OUTPUT_TEMPORAL = true ]; then
    for file in $all_files; do
	FILE_NAME=`omni_f_norm_file_name $file`     # ./hoge/fuga.f90 -> hoge_2f_fuga_2f_a
	EXT=${file##*.}
	FILE_F=${TEMP_DIR}/${FILE_NAME}.${EXT}
	omni_exec cp $FILE_F __omni_tmp__${FILE_NAME}
	echo "output __omni_tmp__${FILE_NAME}"
    done
fi
[ $STOP_BACKEND = true ] && exit 0;

### Native Compiler ###
if [ $ENABLE_ACC = true ]; then
    OMNI_FC_OPT="$OMNI_FC_OPT ${OPENACC_DEF}"
else
    OMNI_FC_OPT="$OMNI_FC_OPT ${OPENMP_DEF}"
fi
for file in $all_files; do
    FILE_NAME=`omni_f_norm_file_name $file`     # ./hoge/fuga.f90 -> hoge_2f_fuga_2f_a
    EXT=${file##*.}
    FILE_F=${TEMP_DIR}/${FILE_NAME}.${EXT}
    FILE_USER_O=`basename $file .${EXT}`.o
    FILE_O=${TEMP_DIR}/${FILE_NAME}_${EXT}.o

    omni_exec $OMNI_FC_CMD $NATIVE_ADD_OPT $OMNI_FC_OPT $other_args $FILE_F -o $FILE_O

    ### GPU Compiler ###
    FILE_CU=${TEMP_DIR}/${FILE_NAME}_pp.cu
    FILE_GPUO=${TEMP_DIR}/${FILE_NAME}.gpu.o
    if [ -e $FILE_CU ]; then
        omni_exec $OMNI_GPUCC_CMD $OMNI_GPUCC_OPT $FILE_CU -o $FILE_GPUO
        FILE_O_TMP=${TEMP_DIR}/${FILE_NAME}.cpu.o
        omni_exec mv $FILE_O $FILE_O_TMP
        omni_exec ld -r $FILE_O_TMP $FILE_GPUO -o $FILE_O
        omni_exec rm $FILE_O_TMP
    fi
    
    if [ $ENABLE_LINKER = false -a "$OUTPUT_FILE" != "" ]; then
	omni_exec mv $FILE_O $OUTPUT_FILE  # only a single file is created.
    else
	omni_exec cp $FILE_O $FILE_USER_O
    fi
done
[ $STOP_COMPILE = true ] && exit 0;
[ $ENABLE_LINKER = false -a $ENABLE_DEBUG = true ] && exit 0;         # ompf90 -c --debug hoge.c
[ $ENABLE_LINKER = false ] && { omni_exec rm -rf $TEMP_DIR; exit 0; } # ompf90 -c hoge.c

### Linker ###
# collect initialize modules
for file in $all_files; do
    FILE_NAME=`omni_f_norm_file_name $file`     # ./hoge/fuga.f90 -> hoge_2f_fuga_2f_a
    EXT=${file##*.}
    FILE_O=${TEMP_DIR}/${FILE_NAME}_${EXT}.o
    obj_files="$obj_files $FILE_O"
done

# link
if [ $ENABLE_ACC = true ]; then
    LINKER_ADD_OPT="$LINKER_ADD_OPT $OMNI_GPUCC_LIB"
else
    obj_files="$OMPF_MAIN_O $obj_files"
fi

if [ "$OUTPUT_FILE" = "" ]; then
    omni_exec $OMNI_LINKER_CMD $obj_files $OMNI_LINKER_OPT $LINKER_ADD_OPT $other_args $archive_files
else
    omni_exec $OMNI_LINKER_CMD $obj_files $OMNI_LINKER_OPT $LINKER_ADD_OPT $other_args $archive_files -o $OUTPUT_FILE
fi

### Delete temporal directory ###
if [ $ENABLE_DEBUG = false ] && omni_exec rm -rf $TEMP_DIR

exit 0
