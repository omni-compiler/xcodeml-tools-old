#!/bin/bash

# $TSUKUBA_Release: Omni OpenMP Compiler 3 $
# $TSUKUBA_Copyright:
#  PLEASE DESCRIBE LICENSE AGREEMENT HERE
#  $

# ---------- check input/output files ------------------------------------------------------
OUTFILE="$1"
INPFILE="$2"

if [ -z "${OUTFILE}" ]; then
  echo output file not specified
  exit 1
fi

if [ -z "${INPFILE}" ]; then
  echo input file not specified
  exit 1
fi

# ---------- setup temporary files ---------------------------------------------------------
BNAME=`dirname "${INPFILE}"`/`basename "${INPFILE}" .xml`
TMP_OUTFILE="${BNAME}.tmp.xml"
TMP_INPFILE="${BNAME}.in.xml"

OM_INPFILE="$TMP_INPFILE"
OM_OUTFILE="$TMP_OUTFILE"
export OM_INPFILE
export OM_OUTFILE

# ---------- read conf files ---------------------------------------------------------------
if [ -z "${OM_TRANSLATORS}" ]; then
  exit 0
else
  CMD_OPT="-decomp"
  for TID in ${OM_TRANSLATORS}; do
    CONF="${OM_DRIVER_CONF_DIR}/x2x.conf.${TID}"
    if [ -r ${CONF} ]; then
      . ${CONF}
    else
      echo cannot read ${CONF} script.
      exit 1
    fi
  done;
fi

# ---------- setup java --------------------------------------------------------------------
CONF="${OM_DRIVER_CONF_DIR}/java.conf"
if [ -e ${CONF} ]; then
  if [ -r ${CONF} ]; then
    . ${CONF}
  else
    echo cannot read ${CONF} script.
    exit 1
  fi
else
  echo cannot find ${CONF} script.
  exit 1
fi

OMNI_JAR1="${OMNI_HOME}/share/xcalablemp/om-exc-tools.jar"
OMNI_JAR2="${OMNI_HOME}/share/xcalablemp/om-c-back.jar"
OMNI_JAR3="${OMNI_HOME}/share/xcalablemp/om-f-back.jar"
OMNI_JAR4="${OMNI_HOME}/share/xcalablemp/om-common.jar"

if [ -f $OMNI_JAR1 -a -f $OMNI_JAR2 -a -f $OMNI_JAR3 -a -f $OMNI_JAR4 ]; then
  JAVA_CMD="${OMNI_JAVA} ${OMNI_JAVA_OPT} -cp ${OMNI_JAR4}:${OMNI_JAR3}:${OMNI_JAR2}:${OMNI_JAR1} exc.util.omompx ${CMD_OPT}"
elif [ -f "${OMNI_HOME}/classes/exc/util/omompx.class" ]; then
  export CLASSPATH="${OMNI_HOME}/classes:${OMNI_HOME}/../C-BackEnd/binding/classes:${OMNI_HOME}/../C-BackEnd/classes:${OMNI_HOME}/../F-BackEnd/binding/classes:${OMNI_HOME}/../F-BackEnd/classes:${OMNI_HOME}/../XcodeML-Common/classes"
  JAVA_CMD="${OMNI_JAVA} ${OMNI_JAVA_OPT} exc.util.omompx ${CMD_OPT}"
else
  echo program not found.
  exit 1
fi

#--- unescape space characters, which are espaced in omdriver.c (ID=278)
OM_OPTION_ARR=()
for opt in ${OM_OPTIONS}; do
    opt1=$(echo $opt | sed 's/\\s/ /g
                            s/\\t/\t/g
                            s/\\n/\n/g
                            s/\\\\/\\/g')
    OM_OPTION_ARR=( "${OM_OPTION_ARR[@]}" "$opt1" )
done

# ---------- execute translator ------------------------------------------------------------
mv "${INPFILE}" "${TMP_INPFILE}" || exit $?
X2X_CMD=${JAVA_CMD}
args=( -x${OM_LANGID} "${OM_OPTION_ARR[@]}" "${TMP_INPFILE}" -o "${TMP_OUTFILE}" )
set -- "${args[@]}"

if [ "${OM_VERBOSE}" = "1" ]; then
  echo "executing translator ..."
  echo ${X2X_CMD} "$@"
fi
${X2X_CMD} "$@" || exit $?
xmllint --format "${TMP_OUTFILE}" >"${OUTFILE}" || mv "${TMP_OUTFILE}" "${OUTFILE}" || exit $?

if [ "${OM_USE_XMPF}" = "1" ]; then
    mv "${BNAME}.in.F90" "${BNAME}.F90" || exit $?
elif [ "${OM_USE_XMP}" = "1" -a "${useDom}" = "1" ]; then
    mv "${BNAME}.in.c" "${BNAME}.c" || exit $?
elif [ "${OM_USE_ACC}" = "1" ]; then
    mv "${BNAME}.in.c" "${BNAME}.c" || exit $?
fi

exit 0
