#!/bin/bash

### Read configration file and library ###
OMNI_HOME=@OMNI_HOME@
. ${OMNI_HOME}/etc/xmpcc.conf
. ${OMNI_HOME}/libexec/driver_common.sh

### Directory for saving intermediate files ###
PID=$$
TEMP_DIR=/tmp/__omni_tmp__${PID}

### Default options ###
ENABLE_LINKER=true
ONLY_PP=false
VERBOSE=false
OUTPUT_TEMPORAL=false
DRY_RUN=false
STOP_PP=false
STOP_FRONTEND=false
STOP_TRANSLATOR=false
STOP_BACKEND=false
STOP_COMPILE=false
ENABLE_OPENMP=false
ENABLE_XACC=false
ENABLE_SCALASCA_ALL=false
ENABLE_SCALASCA=false
ENABLE_TLOG_ALL=false
ENABLE_TLOG=false

# Additional options defined by command line (e.g. -Wl..)
# These parameters are set in xmp_set_parameters().
OUTPUT_FILE=
PP_ADD_OPT=
FRONTEND_ADD_OPT=
XCODE_TRANSLATOR_ADD_OPT=
BACKEND_ADD_OPT=
NATIVE_ADD_OPT=
LINKER_ADD_OPT=

### Set options ###
# e.g.) xmpcc -I/usr/lib a.c b.c c.o --tmp -Wlfoo -omp lib.a
#
#  compile_args="-I/usr/lib a.c b.c c.o"  # Delete xmpcc options
#  c_files="a.c b.c"                      # Only C files
#  obj_files="c.o"                        # Only Object files
#  other_args="-I/usr/lib lib.a"          # Options for Preprocessor, Compiler, and Linker
# 
#  Note that "-omp" is extracted by xmp_set_parameters, and set "ENABLE_OPENMP".
compile_args=
c_files=
obj_files=
other_args=
xmp_set_parameters ${@+"$@"}
xmp_check_file_exist

### Create temporal directory ###
xmp_exec mkdir $TEMP_DIR

### Clean temporal directory before exit ###
trap "rm -rf $TEMP_DIR; exit 1" 1 2 3 15

### Preprocessor ###
for c_file in $c_files; do
    FILE_PREFIX=`xmp_get_file_prefix $c_file`     # /hoge/fuga/a.c -> hoge_2f_fuga_2f_a
    FILE_PP_C=${TEMP_DIR}/${FILE_PREFIX}_pp.c
    FILE_PP_I=${TEMP_DIR}/${FILE_PREFIX}_pp.i

    xmp_exec $OMNI_REPLACE_PRAGMA_CMD $OMNI_REPLACE_PRAGMA_OPT $c_file -o $FILE_PP_C
    xmp_exec $OMNI_CPP_CMD $PP_ADD_OPT $OMNI_CPP_OPT $other_args $FILE_PP_C ">" $FILE_PP_I
    # AIX compiler cannot output file with ".i" suffix. So, ">" is used.

    if [ $ONLY_PP = true ]; then
	if [ "$OUTPUT_FILE" = "" ]; then
	    xmp_exec cat $FILE_PP_I
	else
	    xmp_exec cat $FILE_PP_I ">>" $OUTPUT_FILE
	fi
    fi
done
[ $ONLY_PP = true ] && { xmp_exec rm -rf $TEMP_DIR; exit 0; }
[ $STOP_PP = true ] && exit 0;

### Frontend ###
for c_file in $c_files; do
    FILE_PREFIX=`xmp_get_file_prefix $c_file`     # /hoge/fuga/a.c -> hoge_2f_fuga_2f_a
    FILE_PP_I=${TEMP_DIR}/${FILE_PREFIX}_pp.i
    FILE_IN_X=${TEMP_DIR}/${FILE_PREFIX}_in.xml

    xmp_exec $OMNI_C2X_CMD $FRONTEND_ADD_OPT $OMNI_C2X_OPT $FILE_PP_I -o $FILE_IN_X
done
[ $STOP_FRONTEND = true ] && exit 0;

### Translator ###
for c_file in $c_files; do
    FILE_PREFIX=`xmp_get_file_prefix $c_file`     # /hoge/fuga/a.c -> hoge_2f_fuga_2f_a
    FILE_IN_X=${TEMP_DIR}/${FILE_PREFIX}_in.xml
    FILE_OUT_X=${TEMP_DIR}/${FILE_PREFIX}_out.xml

    if [ $ENABLE_TLOG_ALL = true ]; then
	PROFILE_OPT="-tlog-all"
    elif [ $ENABLE_TLOG = true ]; then
	PROFILE_OPT="-tlog"
    elif [ $ENABLE_SCALASCA_ALL = true ]; then
	PROFILE_OPT="-scalasca-all"
    elif [ $ENABLE_SCALASCA = true ]; then
	PROFILE_OPT="-scalasca"
    fi

    xmp_exec $OMNI_CX2X_CMD $OMNI_CX2X_OPT $XCODE_TRANSLATOR_ADD_OPT $PROFILE_OPT $FILE_IN_X -o $FILE_OUT_X
    # also create ${TEMP_DIR}/${FILE_PREFIX}_in.c
done
[ $STOP_TRANSLATOR = true ] && exit 0;

### Backend ###
for c_file in $c_files; do
    FILE_PREFIX=`xmp_get_file_prefix $c_file`     # /hoge/fuga/a.c -> hoge_fuga_a
    FILE_IN_X=${TEMP_DIR}/${FILE_PREFIX}_in.c
    FILE_C=${TEMP_DIR}/${FILE_PREFIX}.c
    
    xmp_exec cp $FILE_IN_X $FILE_C
    if [ $OUTPUT_TEMPORAL = true ]; then
	xmp_exec cp $FILE_C __omni_tmp__${FILE_PREFIX}.c
	echo "output __omni_tmp__${FILE_PREFIX}.c"
    fi
done
[ $STOP_BACKEND = true ] && exit 0;

### Native Compiler ###
for c_file in $c_files; do
    FILE_PREFIX=`xmp_get_file_prefix $c_file`     # /hoge/fuga/a.c -> hoge_2f_fuga_2f_a
    FILE_C=${TEMP_DIR}/${FILE_PREFIX}.c
    FILE_O=${TEMP_DIR}/${FILE_PREFIX}.o
    FILE_USER_O=`basename $c_file .c`.o

    [ $ENABLE_OPENMP = true ] && OPENMP_ADD_OPT="$OPENMP_OPT"
    xmp_exec $OMNI_MPICC_CMD $NATIVE_ADD_OPT $OMNI_MPICC_OPT $OPENMP_ADD_OPT $other_args $FILE_C -o $FILE_O
    xmp_exec cp $FILE_O $FILE_USER_O
done

[ $STOP_COMPILE = true ] && exit 0;
[ $ENABLE_LINKER = false ] && { xmp_exec rm -rf $TEMP_DIR; exit 0; }

### Linker ###
# collect initialize modules
for c_file in $c_files; do
    FILE_PREFIX=`xmp_get_file_prefix $c_file`     # /hoge/fuga/a.c -> hoge_2f_fuga_2f_a
    FILE_O=${TEMP_DIR}/${FILE_PREFIX}.o
    obj_files="$obj_files $FILE_O"
done

xmp_exec $XMP_COLLECT_INIT $obj_files --PID ${PID}   # create /tmp/_xmpc_init_${PID}.o
FILE_COLLECT_O=${TEMP_DIR}/__omni_collect__$PID.o
xmp_exec mv /tmp/_xmpc_init_${PID}.o $FILE_COLLECT_O

# link
if [ $ENABLE_TLOG_ALL = true ] || [ $ENABLE_TLOG = true ]; then
    PROFILE_OPT="-ltlog_mpi"
fi

if [ "$OUTPUT_FILE" = "" ]; then
    xmp_exec $OMNI_LINKER_CMD $FILE_COLLECT_O $obj_files $OMNI_LINKER_OPT $PROFILE_OPT $LINKER_ADD_OPT $other_args
else
    xmp_exec $OMNI_LINKER_CMD $FILE_COLLECT_O $obj_files $OMNI_LINKER_OPT $PROFILE_OPT $LINKER_ADD_OPT $other_args -o $OUTPUT_FILE
fi

### Delete temporal directory ###
xmp_exec rm -rf $TEMP_DIR

exit 0
