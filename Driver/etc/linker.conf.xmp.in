#!/bin/bash

hasScalasca=0
hasTlog=0
newOpts=''

LOCK_TYPE=@OMP_LOCK_TYPE@
LIB_THREAD=@OMP_THREAD_TYPE@
LIB_OMPC=ompc_${LOCK_TYPE}_${LIB_THREAD}
GPGPU_PREFIX=@GPGPU_PREFIX@
PID=$$

files=( "$@" )

#-------------------------------------------------
# call xmp_collect_init, which will be abolished
#-------------------------------------------------
INIT_MODULE_OBJ="/tmp/_xmpc_init_${PID}.o"
CMD="@OMNI_HOME@/bin/xmp_collect_init"
args=( --cc @BECC@ --PID ${PID} --C "${files[@]}" )
set -- ${args[@]}
if [ "${OM_VERBOSE}" = "1" ]; then
    echo $CMD "$@"
fi
$CMD "$@" || exit 1

#-------------------------------------------------
# call omni_collect_init
#-------------------------------------------------
COLLECT_INIT_SRC="/tmp/omni_collect_init_${PID}.c"
CMD="@OMNI_HOME@/bin/omni_collect_init"
args=( --C --prefix xmpc -o ${COLLECT_INIT_SRC} "${files[@]}" )
set -- ${args[@]}
if [ "${OM_VERBOSE}" = "1" ]; then
    echo $CMD "$@"
fi
$CMD "$@" || exit 1

#-------------------------------------------------
# set linker options
#-------------------------------------------------
for i in ${OM_OPTIONS}; do
    case ${i} in
        -enable-threads)
            INPFILES="${INPFILES} ${OMNI_HOME}/lib/omp${OM_LANGID}_main.o"
            LIBS="${LIBS} -lxmp_threads -l${LIB_OMPC} -l${LIB_THREAD} -ltlog";;
        -enable-gpu)
            LIBS="${LIBS} -L${GPGPU_PREFIX}/lib64 -lxmp_gpu -lcudart"
            newOpts="${newOpts} ${i}";;
	-facc)
	    LIBS="${LIBS} -L${GPGPU_PREFIX}/lib64 -lacc -lcudart";;
        -prof-scalasca)
            hasScalasca=1;;
        -prof-tlog)
            hasTlog=1;;
        -l*)
            LIBS="${LIBS} ${i}";;
        *)
            newOpts="${newOpts} ${i}";;
    esac
done

GASNET_LIB="@GASNET_LIBS@"
LIBS="${COLLECT_INIT_SRC} ${INIT_MODULE_OBJ} ${LIBS} -lxmp ${GASNET_LIB} @BLASLIB@"

TCA_LIB="@TCA_PREFIX@"
if test "${TCA_LIB}" != ""; then
  LIBS="${LIBS} -L${TCA_LIB} -ltca"
fi

LINKER="@BECC@"
if test ${hasScalasca} -eq 1; then
    LINKER="scalasca --instrument @BECC@"
fi

OM_OPTIONS="${newOpts} -L${OMNI_HOME}/lib"
